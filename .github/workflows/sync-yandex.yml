name: Sync from Yandex.Disk

on:
  workflow_dispatch:  # –¢–û–õ–¨–ö–û —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      folder_url:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞'
        required: true
        default: 'https://disk.yandex.ru/d/Mx014FbR7UGEPg'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: pip install requests beautifulsoup4 lxml
        
    - name: Sync from Yandex.Disk
      env:
        YANDEX_FOLDER: ${{ github.event.inputs.folder_url }}
      run: |
        python3 << 'EOF'
        import requests, json, os, re
        from bs4 import BeautifulSoup
        
        print("üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º...")
        
        # URL –ø—É–±–ª–∏—á–Ω–æ–π –ø–∞–ø–∫–∏
        yandex_url = "$YANDEX_FOLDER"
        print(f"üìÅ –ü–∞–ø–∫–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞: {yandex_url}")
        
        # 1. –ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞–ø–∫–∏
        response = requests.get(yandex_url)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # 2. –ò—â–µ–º –≤—Å–µ –ø–∞–ø–∫–∏ (–Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞–ø–æ–∫ = ID –º–æ–¥–µ–ª–µ–π)
        models = []
        
        # –ò—â–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–∞–ø–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
        folder_links = soup.select('a[href*="/client/"]')
        
        for link in folder_links[:10]:  # –û–≥—Ä–∞–Ω–∏—á–∏–º 10 –ø–∞–ø–∫–∞–º–∏
            folder_name = link.text.strip()
            if folder_name and '/' not in folder_name and '.' not in folder_name:
                print(f"üìÇ –ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞: {folder_name}")
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø–∞–ø–∫–∏
                folder_url = f"{yandex_url}/{folder_name}"
                
                # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏
                try:
                    folder_response = requests.get(folder_url)
                    folder_soup = BeautifulSoup(folder_response.text, 'html.parser')
                    
                    # –ò—â–µ–º —Ñ–æ—Ç–æ –≤ –ø–∞–ø–∫–µ
                    photo_links = folder_soup.select('a[href*=".jpg"], a[href*=".png"], a[href*=".jpeg"]')
                    photos = []
                    
                    for photo_link in photo_links[:5]:  # –ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ –Ω–∞ –º–æ–¥–µ–ª—å
                        photo_href = photo_link.get('href', '')
                        if photo_href and 'yadi.sk' in photo_href:
                            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
                            direct_link = photo_href.replace('/client/', '/i/')
                            photos.append(direct_link)
                    
                    if photos:
                        model = {
                            'id': folder_name.lower().replace(' ', '_'),
                            'name': folder_name.replace('_', ' ').title(),
                            'photos': photos[:3]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ñ–æ—Ç–æ
                        }
                        models.append(model)
                        print(f"   ‚úÖ {len(photos)} —Ñ–æ—Ç–æ")
                    
                except Exception as e:
                    print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        if not models:
            print("‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã–µ")
            models = [
                {
                    'id': 'yandex_test_1',
                    'name': '–¢–µ—Å—Ç –∏–∑ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞',
                    'photos': ['https://picsum.photos/800/1000']
                }
            ]
        
        # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSON
        print(f"\nüìä –ù–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π: {len(models)}")
        
        with open('data/models.json', 'w', encoding='utf-8') as f:
            json.dump(models, f, ensure_ascii=False, indent=2)
        
        print("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/models.json")
        
        # 4. –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        total_photos = sum(len(m['photos']) for m in models)
        print(f"üì∏ –í—Å–µ–≥–æ —Ñ–æ—Ç–æ: {total_photos}")
        
        for model in models:
            print(f"   ‚Ä¢ {model['name']}: {len(model['photos'])} —Ñ–æ—Ç–æ")
        EOF
        
    - name: Commit and push
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add data/models.json
        git commit -m "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        git push
        
    - name: Show result
      run: |
        echo "üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üëâ –°–∞–π—Ç –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã"
        echo "üîó –û—Ç–∫—Ä–æ–π—Ç–µ: https://${{ github.repository_owner }}.github.io/models-portfolio/"
